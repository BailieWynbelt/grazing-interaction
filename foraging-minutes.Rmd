---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

First, remove all objects from the R environment to start fresh each time.

```{r}
# clear the enviroment
rm(list=ls(all=TRUE))
```

------------------------------------------------------------------------

Let's check the working directory to see if it's correct. This chunk sources a script that I use to setup my R environment across scripts. It helps me stay consistent between scripts.

```{r environment}
source(paste0(getwd(), "/environment.R"))

print(currentwd)
```

Check that this file path is correct for your computer.

------------------------------------------------------------------------

Let's get our R environment ready by loading some useful packages. This chunk sources a script where I keep a list of packages I commonly use for analysis.

```{r packages, message=FALSE}
source(paste0(currentwd, "/packages.R"))
```

------------------------------------------------------------------------

Let's load some custom functions into our R environment. This chunk of code sources a script that contains custom functions created to help with analysis.

```{r functions}
source(paste0(currentwd, "/functions.R"))
```

------------------------------------------------------------------------

Now, we can load in the cleaned photo data generated by "photo-processing.Rmd" script. This data has already been corrected for erroneous data, re-named columns for consistency across years, and some columns have been converted to specific data types (e.g., DateTime as a S3:POSIXct).

```{r load data, warning=FALSE}
all_data <- readr::read_csv('data/photo/all_photo_data.csv', col_names = TRUE, na = c(""," ","NA"))

print(all_data)
```

------------------------------------------------------------------------

We're going to use a function I created called "speciestotal" (see the functions.R script) which is specific to the way we classified our data. The issue is that the 'Count1Species' column in our data frames doesn't correspond to a specific species, rather it corresponds to whatever species is the primary species detected (\>50% of individuals if a multiple species are detected in an image).

The "speciestotal" function will count up the number of individuals for each species detected in a camera trap photo and then create a new column in the corresponding dataframe to store this species count. The new column is labled by the species and contains a count of the number of individuals detected in each image.

A second function "allspecies" uses the "speciestotal" function for all of the species possible (24 total), and creates a new column for each species.

```{r species counts}
all_data_all_species <- allspecies(all_data)

view(all_data_all_species)
```

------------------------------------------------------------------------

This new data frame has 24 additional columns that contain counts of the 'subjects' (e.g., horses, cows, ATVs, humans) in each photo. These columns were created primarily to simplify the data frame, where a single row has the counts for each species stored in a separate column.

```{r bear timelapse 2018}
BRL_2018 <- all_data_all_species %>% 
  dplyr::filter(Site == "Bear Timelapse") %>% 
  dplyr::filter(Year == "2018")
  
print(BRL_2018)
```

```{r bear timelapse 2019}
BRL_2019 <- all_data_all_species %>% 
  dplyr::filter(Site == "Bear Timelapse") %>% 
  dplyr::filter(Year == "2019")
  
print(BRL_2019)
```

------------------------------------------------------------------------

Let's check the operational dates for Bear Timelapse 2018. This represents only the dates in this data frame, which corresponds only to 'subject' photos. This data frame does not contain blank or empty photos that were sorted out during an earlier phase of photo processing.

```{r}
BRL_2018 %>% pull(DateTime) %>% lubridate::date() %>% unique()
```

```{r}
BRL_2019 %>% pull(DateTime) %>% lubridate::date() %>% unique()
```

These operational dates represent days with observations containing subjects, but does not contain the dates without observations, but where the camera was still functioning.

------------------------------------------------------------------------

Let's calculate foraging minutes using the Bear Timelapse 2018 data. From our metadata, we know that the Bear Timelapse site in 2018 used a 1 minute collection interval for timelapse photos. 

```{r}
calc.foraging.time.unwtd <- function(cameradf, interval) {
  cameradf <- cameradf %>% dplyr::mutate(horse_forage_unwtd = horse * interval)
  
  cameradf <- cameradf %>% dplyr::mutate(cow_forage_unwtd = cow * interval)
  
  cameradf <- cameradf %>% dplyr::mutate(elk_forage_unwtd = elk * interval)
  
  return(cameradf)
}

calc.foraging.time.wtd <- function(cameradf, interval) {
  cameradf <- cameradf %>% dplyr::mutate(horse_forage_wtd = horse * interval * 1.1)
  
  cameradf <- cameradf %>% dplyr::mutate(cow_forage_wtd = cow * interval * 1)
  
  cameradf <- cameradf %>% dplyr::mutate(elk_forage_wtd = elk * interval * 0.7)
  
  return(cameradf)
}
```

```{r}
BRL_2019 <- calc.foraging.time.unwtd(BRL_2019, interval = 5)

view(BRL_2019)
```

```{r}
BRL_2019 <- calc.foraging.time.wtd(BRL_2019, interval = 5)

view(BRL_2019)
```

```{r}
BRL_2019 <- BRL_2019 %>% 
   dplyr::mutate(Date = lubridate::date(DateTime), .after = Year)

print(BRL_2019)
```

```{r}
BRL_2019 %>% pull(horse_forage_unwtd) %>% sum()

BRL_2019 %>% pull(horse_forage_wtd) %>% sum()
```


```{r}
BRL_2018 <- BRL_2018 %>% mutate(horse_forage_unwtd = horse * 1)

BRL_2018 <- BRL_2018 %>% mutate(cow_forage_unwtd = cow * 1)

BRL_2018 <- BRL_2018 %>% mutate(elk_forage_unwtd = elk * 1)

view(BRL_2018)
```

```{r}
BRL_2018 <- BRL_2018 %>% 
  mutate(horse_forage_wtd = horse_forage_unwtd * 1.1)

BRL_2018 <- BRL_2018 %>% 
  mutate(cow_forage_wtd = cow_forage_unwtd * 1)

BRL_2018 <- BRL_2018 %>% 
  mutate(elk_forage_wtd = elk_forage_unwtd * 0.7)

view(BRL_2018)
```

```{r}
BRL_2018 %>% pull(horse_forage_unwtd) %>% sum()

BRL_2018 %>% pull(horse_forage_wtd) %>% sum()
```

```{r}
BRL_2018 %>% pull(cow_forage_unwtd) %>% sum()

BRL_2018 %>% pull(cow_forage_wtd) %>% sum()
```

```{r}
BRL_2018 %>% pull(elk_forage_unwtd) %>% sum()

BRL_2018 %>% pull(elk_forage_wtd) %>% sum()
```

```{r}
BRL_2018 <- BRL_2018 %>% 
   dplyr::mutate(Date = lubridate::date(DateTime), .after = Year)

print(BRL_2018)
```

```{r}
BRL_2019 <- BRL_2019 %>% 
   dplyr::mutate(Date = lubridate::date(DateTime), .after = Year)

print(BRL_2019)
```

```{r}
summarize.unwtd.daily.totals <- function(cameradf){

  cameradf_horses <- NULL
  cameradf_horses <- cameradf %>% 
    dplyr::group_by(Date) %>% 
    dplyr::summarise(daily_total_unwtd = sum(horse_forage_unwtd))
  cameradf_horses <- cameradf_horses %>% mutate(Species = "Horse")
  
  cameradf_cows <- NULL
  cameradf_cows <- cameradf %>% 
    dplyr::group_by(Date) %>% 
    dplyr::summarise(daily_total_unwtd = sum(cow_forage_unwtd))
  cameradf_cows <- cameradf_cows %>% mutate(Species = "Cow")  
  
  cameradf_elk <- NULL
  cameradf_elk <- cameradf %>% 
    dplyr::group_by(Date) %>% 
    dplyr::summarise(daily_total_unwtd = sum(elk_forage_unwtd))
  cameradf_elk <- cameradf_elk %>% mutate(Species = "Elk")  
  
  cameradf <- dplyr::bind_rows(cameradf_horses, cameradf_cows, cameradf_elk)
  
  return(cameradf)
}

summarize.wtd.daily.totals <- function(cameradf){

  cameradf_horses <- NULL
  cameradf_horses <- cameradf %>% 
    dplyr::group_by(Date) %>% 
    dplyr::summarise(daily_total_wtd = sum(horse_forage_wtd))
  cameradf_horses <- cameradf_horses %>% mutate(Species = "Horse")
  
  cameradf_cows <- NULL
  cameradf_cows <- cameradf %>% 
    dplyr::group_by(Date) %>% 
    dplyr::summarise(daily_total_wtd = sum(cow_forage_wtd))
  cameradf_cows <- cameradf_cows %>% mutate(Species = "Cow")  
  
  cameradf_elk <- NULL
  cameradf_elk <- cameradf %>% 
    dplyr::group_by(Date) %>% 
    dplyr::summarise(daily_total_wtd = sum(elk_forage_wtd))
  cameradf_elk <- cameradf_elk %>% mutate(Species = "Elk")  
  
  cameradf <- dplyr::bind_rows(cameradf_horses, cameradf_cows, cameradf_elk)
  
  return(cameradf)
}
```

```{r}
BRL_2019_unwtd_summary <- summarize.unwtd.daily.totals(BRL_2019)

BRL_2019_unwtd_summary

BRL_2019_wtd_summary <- summarize.wtd.daily.totals(BRL_2019)

BRL_2019_wtd_summary
```

```{r}
BRL_2018_horse_forage_unwtd_summary <- BRL_2018 %>% 
  dplyr::group_by(Date) %>% 
  dplyr::summarise(daily_total_unwtd = sum(horse_forage_unwtd))

# BRL_2018_horse_forage_wtd_summary <- BRL_2018 %>% dplyr::group_by(Date) %>% dplyr::summarise(daily_total_wtd = sum(horse_forage_wtd))

BRL_2018_horse_forage_unwtd_summary <- BRL_2018_horse_forage_unwtd_summary %>% 
  dplyr::mutate(Species = "Horse")

print(BRL_2018_horse_forage_unwtd_summary)
```

```{r}
BRL_2018_cow_forage_unwtd_summary <- BRL_2018 %>% dplyr::group_by(Date) %>% dplyr::summarise(daily_total_unwtd = sum(cow_forage_unwtd))

BRL_2018_cow_forage_unwtd_summary <- BRL_2018_cow_forage_unwtd_summary %>% 
  mutate(Species = "Cow")

BRL_2018_cow_forage_unwtd_summary
```
```{r}
BRL_2018_elk_forage_unwtd_summary <- BRL_2018 %>% dplyr::group_by(Date) %>% dplyr::summarise(daily_total_unwtd = sum(elk_forage_unwtd))

BRL_2018_elk_forage_unwtd_summary <- BRL_2018_elk_forage_unwtd_summary %>% 
  mutate(Species = "Elk")

BRL_2018_elk_forage_unwtd_summary
```

```{r}
# BRL_2018_unwtd_summary <- dplyr::inner_join(BRL_2018_horse_forage_unwtd_summary,
#                                             BRL_2018_cow_forage_unwtd_summary,
#                                             by = "Date") %>% inner_join(BRL_2018_elk_forage_unwtd_summary, by = "Date")
# 
# BRL_2018_unwtd_summary
```


```{r}
BRL_2018_unwtd_summary <- dplyr::bind_rows(BRL_2018_horse_forage_unwtd_summary,
                                                  BRL_2018_cow_forage_unwtd_summary,
                                                  BRL_2018_elk_forage_unwtd_summary)

print(BRL_2018_unwtd_summary)
```


```{r}
p <- ggplot(BRL_2018_unwtd_summary, aes(x = Date, y = daily_total_unwtd, fill = Species)) +
  geom_col() +
  scale_x_date(date_labels = "%b", 
               date_breaks = "1 month", 
               limits = c(date("2018-01-01"), date("2018-12-31"))) +
  scale_y_continuous(limits = c(0, 700), breaks = seq(0, 700, by = 100)) +
  labs(title = "Bear Time-Lapse", subtitle = "2018") +
  ylab("Unweighted Forage Minutes") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.text.x = element_text(margin = margin(t = 0, r = 0, b = 10, l = 0)),
        axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 10)))

p
```

```{r}
# ggsave("Bear-Timelapse-2018-Unweighted-Forage-Minutes-Combined-Species.jpg",
#      path = paste0(currentwd,"/figures", "/forage-minutes"))
```
```{r}
p <- ggplot(BRL_2019_unwtd_summary, aes(x = Date, y = daily_total_unwtd, fill = Species)) +
  geom_col(position = "dodge") +
  scale_x_date(date_labels = "%b",
               date_minor_breaks = "1 day",
               date_breaks = "1 month",
               limits = c(date("2019-06-01"), date("2019-08-31"))) +
  labs(title = "Bear Time-Lapse", subtitle = "2019") +
  ylab("Unweighted Forage Minutes") +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.text.x = element_text(margin = margin(t = 10, r = 0, b = 10, l = 0)),
        axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 10)))

p
```

```{r}
ggsave("Bear-Timelapse-2019-Unweighted-Forage-Minutes-June-01-August-31.jpg",
     path = paste0(currentwd,"/figures", "/forage-minutes"))
```
