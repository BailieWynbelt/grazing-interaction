---
title: "Photo Data Processing"
author: "Andrew Antaya"
output:
  html_document:
    df_print: paged
---
***
First, let's get our R environment ready by loading some useful packages.

***

Then, let's remove all objects from the environment to start fresh each time.
```{r}
# clear the enviroment
rm(list=ls(all=TRUE))
```

***
Let's check the working directory to see if it's correct.
```{r}
source(paste0(getwd(), "/environment.R"))

print(currentwd)
```
Looks good for my (Andrew's) PC
***
I created an external R script with contains all of the functions that I commonly use across different scripts. This chunk of code reads in those functions into the global R environment.
```{r include=FALSE}
## the source() funciton executes all lines of code in the "mentioned" script (i.e. the pathway)
source(paste0(currentwd, "/packages.R"))
```

```{r}
source(paste0(currentwd, "/functions.R"))
```
***
Let's read in the RAW photo data from 2017 and 2018, which human observers classified in a custom Excel macro (.xlsm written in VBA). The macro generates data for each image when a human observer selects different options based on what they see in each photo. We saved each of the .xlsm files (each file corresponding to a site and year) as .csv files for ease of use in R and to convert the .xlsm to a non-proprietary format.

For the first step in cleaing up the camera data, we are going to treat all fields with "" (blanks), " " (spaces- typically accidental input which is invisble in Excel), or "NA" (characters), as NA's inside R using the function na.strings(). This will help us deal with missing information in our dataset.
```{r}
# read in the 2017 data, treating all blanks, spaces, and "NA"s as NA's
BGW17 <- readr::read_csv('data/photo/BGW_2017.csv', col_names = TRUE, na = c(""," ","NA"))
WCS17 <- readr::read_csv('data/photo/WCS_2017.csv', col_names = TRUE, na = c(""," ","NA"))
BRL17 <- readr::read_csv('data/photo/BRL_2017.csv', col_names = TRUE, na = c(""," ","NA"))
BKS17 <- readr::read_csv('data/photo/BKS_2017.csv', col_names = TRUE, na = c(""," ","NA"))

print(BGW17)
print(WCS17)
print(BRL17)
print(BKS17)
```

```{r}
# read in the 2018 data, treating all blanks, spaces, and "NA"s as NA's
BGX18 <- readr::read_csv('data/photo/BGX_2018.csv', col_names = TRUE, na = c(""," ","NA"))
BGW18 <- readr::read_csv('data/photo/BGW_2018.csv', col_names = TRUE, na = c(""," ","NA"))
BGT18 <- readr::read_csv('data/photo/BGT_2018.csv', col_names = TRUE, na = c(""," ","NA"))
WCX18 <- readr::read_csv('data/photo/WCX_2018.csv', col_names = TRUE, na = c(""," ","NA"))
WCS18 <- readr::read_csv('data/photo/WCS_2018.csv', col_names = TRUE, na = c(""," ","NA"))
WCT18 <- readr::read_csv('data/photo/WCT_2018.csv', col_names = TRUE, na = c(""," ","NA"))
BRL18 <- readr::read_csv('data/photo/BRL_2018.csv', col_names = TRUE, na = c(""," ","NA"))
# BKS18 is incomplete but once it is done it will be read in
# BKS18RAW<-readr::read_csv('data/photo/BKS_2018.csv.csv', col_names = TRUE, na = c(""," ","NA"))

print(BGX18)
print(BGW18)
print(BGT18)
print(WCX18)
print(WCS18)
print(WCT18)
print(BRL18)
```

```{r}
# read in the 2019 data, treating all blanks, spaces, and "NA"s as NA's_19_RAW <- readr::read_csv("data/photo/A51_2019.csv", col_names = TRUE, na = c(""," ","NA"))
AFO19 <- readr::read_csv("data/photo/A51_2019.csv", col_names = TRUE, na = c(""," ","NA"))
BKD19 <- readr::read_csv("data/photo/BKD_2019.csv", col_names = TRUE, na = c(""," ","NA"))
BKN19 <- readr::read_csv("data/photo/BKN_2019.csv", col_names = TRUE, na = c(""," ","NA"))
BKS19 <- readr::read_csv("data/photo/BKS_2019.csv", col_names = TRUE, na = c(""," ","NA"))
BRL19 <- readr::read_csv("data/photo/BRL_2019.csv", col_names = TRUE, na = c(""," ","NA"))
BRT19 <- readr::read_csv("data/photo/BRT_2019.csv", col_names = TRUE, na = c(""," ","NA"))

print(AFO19)
print(BKD19)
print(BKN19)
print(BKS19)
print(BRL19)
print(BRT19)
```

```{r}
# read in the 2020 data, treating all blanks, spaces, and "NA"s as NA's
AFO20 <- readr::read_csv("data/photo/A51_2020.csv", col_names = TRUE, na = c(""," ","NA"))
BKN20 <- readr::read_csv("data/photo/BKN_2020.csv", col_names = TRUE, na = c(""," ","NA"))
BKS20 <- readr::read_csv("data/photo/BKS_2020.csv", col_names = TRUE, na = c(""," ","NA"))
BRL20 <- readr::read_csv("data/photo/BRL_2020.csv", col_names = TRUE, na = c(""," ","NA"))

print(AFO20)
print(BKN20)
print(BKS20)
print(BRL20)
```
***
We read in CSV files containing the camera data. Each data frame corresponds to a site and year (e.g., BGW18 is Boggy West Timelapse, data from year 2018). In all of the data frames, each row corresponds to a single image and each column corresponds to a single 'variable'. Some of these 'variables' are actually metadata, such as the file name of the image and the file path.
***

```{r}
BGW17 <- BGW17 %>% dplyr::mutate(Site = "Boggy", Year = 2017)
WCS17 <- WCS17 %>% dplyr::mutate(Site = "Wildcat", Year = 2017)
BRL17 <- BRL17 %>% dplyr::mutate(Site = "Bear", Year = 2017)
BKS17 <- BKS17 %>% dplyr::mutate(Site = "Black Canyon South", Year = 2017)
```

```{r}
data_2017 <- dplyr::bind_rows(BGW17, WCS17, BRL17, BKS17)

data_2017 <- data_2017 %>% relocate(Site, .before = RecordNumber)

data_2017 <- data_2017 %>% relocate(Year, .after = Site)

print(data_2017)
```

```{r}
BGX18 <- BGX18 %>% dplyr::mutate(Site = "Boggy Exclosure", Year = 2018)
BGW18 <- BGW18 %>% dplyr::mutate(Site = "Boggy West", Year = 2018)
BGT18 <- BGT18 %>% dplyr::mutate(Site = "Boggy Trail", Year = 2018)
WCX18 <- WCX18 %>% dplyr::mutate(Site = "Wildcat Exclosure", Year = 2018)
WCS18 <- WCS18 %>% dplyr::mutate(Site = "Wildcat South", Year = 2018)
WCT18 <- WCT18 %>% dplyr::mutate(Site = "Wildcat Trail", Year = 2018)
BRL18 <- BRL18 %>% dplyr::mutate(Site = "Bear Timelapse", Year = 2018)
```

```{r}
data_2018 <- dplyr::bind_rows(BGX18, BGW18, BGT18, WCX18, WCS18, WCT18, BRL18)

data_2018 <- data_2018 %>% relocate(Site, .before = RecordNumber)

data_2018 <- data_2018 %>% relocate(Year, .after = Site)

print(data_2018)
```

```{r}
AFO19 <- AFO19 %>% dplyr::mutate(Site = "Fifty One", Year = 2019)
BKD19 <- BKD19 %>% dplyr::mutate(Site = "Black Canyon Dam", Year = 2019)
BKN19 <- BKN19 %>% dplyr::mutate(Site = "Black Canyon North", Year = 2019)
BKS19 <- BKS19 %>% dplyr::mutate(Site = "Black Canyon South", Year = 2019)
BRL19 <- BRL19 %>% dplyr::mutate(Site = "Bear Timelapse", Year = 2019)
BRT19 <- BRT19 %>% dplyr::mutate(Site = "Bear Trail", Year = 2019)
```

```{r}
data_2019 <- dplyr::bind_rows(AFO19, BKD19, BKN19, BKS19, BRL19, BRT19)

data_2019 <- data_2019 %>% relocate(Site, .before = RecordNumber)

data_2019 <- data_2019 %>% relocate(Year, .after = Site)

data_2019$LastSavedOn <- data_2019 %>% pull(LastSavedOn) %>% openxlsx::convertToDateTime()

print(data_2019)
```

```{r}
AFO20 <- AFO20 %>% dplyr::mutate(Site = "Fifty One", Year = 2020)
BKN20 <- BKN20 %>% dplyr::mutate(Site = "Black Canyon North", Year = 2020)
BKS20 <- BKS20 %>% dplyr::mutate(Site = "Black Canyon South", Year = 2020)
BRL20 <- BRL20 %>% dplyr::mutate(Site = "Bear Timelapse", Year = 2020)
```

```{r}
data_2020 <- dplyr::bind_rows(AFO20, BKN20, BKS20, BRL20)

data_2020 <- data_2020 %>% relocate(Site, .before = RecordNumber)

data_2020 <- data_2020 %>% relocate(Year, .after = Site)

data_2020$LastSavedOn <- data_2020 %>% pull(LastSavedOn) %>% openxlsx::convertToDateTime()

print(data_2020)
```

Some of the images we classified in the Excel macro were 'empty' (i.e. the observer could not detect a subject in the image). We want to remove these empty images from analysis.

We're going to use the "Count1Species"" column in each data frame to remove 'empty' photos. The "Count1Species" column corresponds to the 1st detected species in each photo (i.e. the primary species (>50%) if more than one species is detected in a photo). If the image is 'empty' then it will have "NA" for a value in the "Count1Species" column. We're going to use the function complete.cases() to remove all of the rows that have "NA" in the "Count1Species" column. We'll do this for each of the dataframes, and save these new dataframes into new objects.

```{r}
data_2017 %>% pull(Count1Species) %>% length()

data_2017_drop_na <- data_2017 %>% tidyr::drop_na(Count1Species)

data_2017_drop_na %>% pull(Count1Species) %>% length()
```

```{r}
data_2018 %>% pull(Count1Species) %>% length()

data_2018_drop_na <- data_2018 %>% tidyr::drop_na(Count1Species)

data_2018_drop_na %>% pull(Count1Species) %>% length()
```

```{r}
data_2019 %>% pull(Count1Species) %>% length()

data_2019_drop_na <- data_2019 %>% tidyr::drop_na(Count1Species)

data_2019_drop_na %>% pull(Count1Species) %>% length()
```

```{r}
data_2019_drop_na %>% dplyr::filter(Site == "Bear Timelapse")
```



```{r}
data_2020 %>% pull(Count1Species) %>% length()

data_2020_drop_na <- data_2020 %>% tidyr::drop_na(Count1Species)

data_2020_drop_na %>% pull(Count1Species) %>% length()
```

***
Now we apply the clean dates function to our data.
```{r}
# TODO consider changing the clean.dates function to specify a column 
# instead of supplying a data frame and always selecting the ImageDate column
data_2017_clean_dates <- clean.dates(data_2017_drop_na)

data_2017_clean_dates$LastSavedOn <- data_2017_clean_dates %>% pull(LastSavedOn) %>% lubridate::mdy_hm()

print(data_2017_clean_dates)
```

```{r}
data_2018_clean_dates <- clean.dates(data_2018_drop_na)

data_2018_clean_dates$LastSavedOn <- data_2018_clean_dates %>% pull(LastSavedOn) %>% lubridate::mdy_hm()

print(data_2018_clean_dates)
```

```{r}
data_2019_drop_na$DateTime <- data_2019_drop_na %>% pull(DateTime) %>% lubridate::ymd_hms()

data_2019_clean_dates <- data_2019_drop_na %>% select(-c("ImageTime", "ImageDate"))

print(data_2019_clean_dates)
```

```{r}
data_2020_drop_na$DateTime <- data_2020_drop_na %>% pull(DateTime) %>% lubridate::ymd_hms()

data_2020_clean_dates <- data_2020_drop_na %>% select(-c("ImageTime", "ImageDate"))

print(data_2020_clean_dates)
```

***
```{r}
print(data_2017_clean_dates)

data_2018_rename_col <- data_2018_clean_dates %>% rename(multi = TraitB2)

data_2018_rename_col <- data_2018_rename_col %>% rename(water = Trait4)

print(data_2018_rename_col)

data_2019_rename_col <- data_2019_clean_dates %>% rename(multi = TraitB2)

data_2019_rename_col <- data_2019_rename_col %>% rename(water = Trait4)

print(data_2019_rename_col)

data_2020_rename_col <- data_2020_clean_dates %>% rename(multi = TraitB2)

data_2020_rename_col <- data_2020_rename_col %>% rename(water = Trait4)

print(data_2020_rename_col)
```

```{r}
all_photo_data <- bind_rows(data_2017_clean_dates, 
                            data_2018_rename_col, 
                            data_2019_rename_col, 
                            data_2020_rename_col)

view(all_photo_data)
```

```{r}
all_photo_data %>% dplyr::filter(Site == "Bear Timelapse" & Year == "2019") %>% view()
```

```{r}
readr::write_csv(all_photo_data, file.path(currentwd, "data", "photo", "all_photo_data.csv"))
```
