---
title: "R Notebook"
output:
  html_notebook: default
  pdf_document: default
---
White Mountain Sites  
Boggy and Wildcat Creek  
Production and Utilization calculations  
2021-08-20  
Written by Andrew Antaya

Clear the R environment to start from a clean slate.
```{r}
# clear the environment
rm(list=ls(all=TRUE))
```

Read in the required packages from another R script in the current working directory.
```{r}
source("packages.R")
```

Read in the required functions from another R script in the current working directory.
```{r}
source("functions.R")
```

Read in the vegetation data from the White Mountains study sites. The data from 2017 and 2018 was re-arranged so that all of the data from the exclosure frames were grouped together in order. This was done to tidy up the data and make it easier to analyze.
```{r}
## read in csv data
wm_prod_2017 <- readr::read_csv('data/vegetation/white-mountains/2017-white-mountains-production-reordered.csv',
                                col_names = TRUE, 
                                na = c(""," ","NA"))

wm_prod_2018 <- readr::read_csv('data/vegetation/white-mountains/2018-white-mountains-production-reordered.csv',
                                col_names = TRUE,
                                na = c(""," ","NA"))

wm_prod_2019 <- readr::read_csv('data/vegetation/white-mountains/2019-white-mountains-production.csv',
                                col_names = TRUE,
                                na = c(""," ","NA"))

```
The output shows our column names, and how they're stored inside R. This is important because the variable type can affect our analysis if we're not careful. For example, the "Plot" column is recognized as a character in 2017 and 2018, but as a double in 2019.

To fix this. force conversion of the 2019 "Plot" column to a character type. We could also force it into a factor, but for our purposes it doesn't really matter. The "Plot" column is really more for organization than for anything else.
```{r}
wm_prod_2019$Plot <- as.character(wm_prod_2019$Plot)

wm_prod_2019
```

Let's take a closer look at the data.
```{r}
print(wm_prod_2017)

print(wm_prod_2018)

print(wm_prod_2019)
```
Each data frame has 13 columns (variables). The data from 2017 and 2019 have 20 rows (observations).
However, the data from 2018 has 22 rows. We sampled 6 riparian frames from Boggy and Wildcat in 2018 instead of the usual 5 frames.

It's a good practice to recalculate columns that were calculated in Excel. It's easy to make a mistake in Excel. Since Excel calculated the "TotalDryWt" column, let's re-calculate the total dry weight by adding the bag weights columns together, and storing these values in a new column "TotalWt".
```{r}
wm_prod_2017 <- wm_prod_2017 %>% 
  dplyr::mutate(TotalWt = select(., Bag1DryWt:Bag8DryWt) %>% rowSums(na.rm = TRUE))

wm_prod_2018 <- wm_prod_2018 %>% 
  dplyr::mutate(TotalWt = select(., Bag1DryWt:Bag8DryWt) %>% rowSums(na.rm = TRUE))

wm_prod_2019 <- wm_prod_2019 %>% 
  dplyr::mutate(TotalWt = select(., Bag1DryWt:Bag8DryWt) %>% rowSums(na.rm = TRUE))

print(wm_prod_2017)
print(wm_prod_2018)
print(wm_prod_2019)
```
There are erroneous data points in our 2019 data, however, that we need to adjust. 
For 2019 in Wildcat, instead of clipping the entire 1m X 1m grazing exclosure, we clipped three 40cm x 40 cm quadrats randomly placed inside of the exclosure. We decided to clip a smaller area to save time. This differs from how we clipped the Boggy Creek site for the same year. For Boggy, we clipped the entire 1m x 1m exclosure.

To correct this error, the first step is to calculate the area of (1) 40cm x 40 cm quadrat.
```{r}
# length of quadrat dimension X (in centimeters)
dim_x <- units::set_units(40, cm)

# length of quadrat dimension Y (in centimeters)
dim_y <- units::set_units(40, cm)

# calculate the area of the sampling frame in centimeters
sample_area_cm <- dim_x*dim_y

print(sample_area_cm)
```
Next, find the total area of (3) 40cm x 40cm quadrats in centimeters[^2].
```{r}
# number of sampling frames/quadrats
n_frames <- 3

# calculate total area of three 40cm x 40cm quadrats
total_area_cm <- sample_area_cm*n_frames

print(total_area_cm)
```
Convert from centimeters[^2] to meters[^2]. This is total area sampled by three 40cm x 40cm quadrats.
```{r}
total_area_m2 <-  set_units(total_area_cm, m^2)

print(total_area_m2)
```
Take the reciprocal of the total area sampled by 3 quadrats. We want to know how much we need to multiply by get the total area sampled by three 40cm x 40cm quadrats to equal 1 m[^2].
```{r}
conversion <- as.numeric(1/total_area_m2)

print(conversion)
```
Adjust the total dry weight of the exclosure frames for the Wildcat site. The adjusted weight is stored in a new column.
```{r}
wm_prod_2017$AdjustedWt <- NULL
wm_prod_2018$AdjustedWt <- NULL
wm_prod_2019$AdjustedWt <- NULL

# if you run this line it will multiply it by the conversion multiple times
wm_prod_2019$AdjustedWt <- ifelse (wm_prod_2019$Site == "Wildcat" & wm_prod_2019$Type == "Exclosure", 
                           wm_prod_2019$TotalDryWt*conversion, 
                           wm_prod_2019$TotalDryWt)

print(wm_prod_2019)
```

We also need to adjust the weights of the residuals. We clipped (1) 40cm x 40cm quadrat for each residual plot. We will need to convert this area to m[^2].
```{r}
# length of quadrat dimension X (in centimeters)
dim_x <- units::set_units(40, cm)

# length of quadrat dimension Y (in centimeters)
dim_y <- units::set_units(40, cm)

# calculate the area of the sampling frame in centimeters
sample_area_cm <- dim_x*dim_y

# number of sampling frames/quadrats
n_frames <- 1

# calculate total area of three 40cm x 40cm quadrats
total_area_cm <- sample_area_cm*n_frames

# convert from cm[^2] to m[^2]
total_area_m2 <-  set_units(total_area_cm, m^2)

# print the total sampling area
print(total_area_m2)
```
```{r}
conversion <- (1/total_area_m2)

conversion <- as.numeric(conversion)

print(conversion)
```
Adjust the total dry weight of the residual frames for both sites. The adjusted weight is stored in a new column.
```{r}
# if you run this line it will multiply it by the conversion multiple times
# TODO another way to do this would be to combine cases, perform the operation, and then filter by year
# this would reduce repetitive code
wm_prod_2017$AdjustedWt <- dplyr::if_else (wm_prod_2017$Type == "Residual", 
                                   wm_prod_2017$TotalDryWt*conversion, 
                                   wm_prod_2017$TotalDryWt)

wm_prod_2018$AdjustedWt <- dplyr::if_else (wm_prod_2018$Type == "Residual", 
                                   wm_prod_2018$TotalDryWt*conversion, 
                                   wm_prod_2018$TotalDryWt)

wm_prod_2019$AdjustedWt <- dplyr::if_else (wm_prod_2019$Type == "Residual", 
                                   wm_prod_2019$TotalDryWt*conversion, 
                                   wm_prod_2019$TotalDryWt)
print(wm_prod_2017)
print(wm_prod_2018)
print(wm_prod_2019)
```

```{r}
combined_df <- bind_rows(wm_prod_2017, wm_prod_2018, wm_prod_2019)

residual <- filter(combined_df, Type == "Residual")

production <- filter(combined_df, Type == "Exclosure")

print(production)

print(residual)
```
Write out the combined and adjusted csv data.
```{r}
#readr::write_csv(combined_df, "data/vegetation/white-mountains/white-mountains-production-all-years-combined.csv")
```

Convert to new units.
```{r}
production$AdjustedWt <- set_units(production$AdjustedWt, g/m^2)

production$kg_ha <- NA

production$kg_ha <- set_units(production$AdjustedWt, kg/hectare)

production$lb_acre <- NA

production$lb_acre <- set_units(production$AdjustedWt, lb/acre)

print(production)
```

Create empty data frame to store the mean, standard deviation, standard error, 95% confidence interval for all sites.
```{r}
stats<- data.frame(sites=c("BGW17", "BGW18", "BGW19", "WCS17", "WCS18", "WCS19"), avg_grams_meter = NA, 
                   avg_kg_hectare = NA, avg_lbs_acre = NA, sd = NA, se = NA, L95 = NA, U95 = NA)
print(stats)
```

```{r}
## calculate mean production values for each year and site (in g/m2)
stats$avg_grams_meter[1] <- mean(pull(filter(production, Site == "Boggy" & Year == "2017"), "AdjustedWt"))
stats$avg_grams_meter[2] <- mean(pull(filter(production, Site == "Boggy" & Year == "2018"), "AdjustedWt"))
stats$avg_grams_meter[3] <- mean(pull(filter(production, Site == "Boggy" & Year == "2019"), "AdjustedWt"))
stats$avg_grams_meter[4] <- mean(pull(filter(production, Site == "Wildcat" & Year == "2017"), "AdjustedWt"))
stats$avg_grams_meter[5] <- mean(pull(filter(production, Site == "Wildcat" & Year == "2018"), "AdjustedWt"))
stats$avg_grams_meter[6] <- mean(pull(filter(production, Site == "Wildcat" & Year == "2019"), "AdjustedWt"))

print(stats)
```

```{r}
# Convert to different units using the set_units() function
stats$avg_grams_meter <- set_units(stats$avg_grams_meter, g/m^2)
stats$avg_kg_hectare <- set_units(stats$avg_grams_meter, kg/hectare)
stats$avg_lbs_acre <- set_units(stats$avg_grams_meter, lb/acre)
stats$avg_grams_meter <- as.numeric(stats$avg_grams_meter)
stats$avg_kg_hectare <- as.numeric(stats$avg_kg_hectare)
stats$avg_lbs_acre <- as.numeric(stats$avg_lbs_acre)
print(stats)
```

```{r}
testavg <- mean(pull(filter(production, Site == "Boggy" & Year == "2017"), "lb_acre"))
testavg

testsd <- sd(pull(filter(production, Site == "Boggy" & Year == "2017"), "lb_acre"))
testsd

testse <- se(pull(filter(production, Site == "Boggy" & Year == "2017"), "lb_acre"))
testse
```

```{r}
## calculate standard deviation SD for each year and site (in g/m2)
stats$sd[1] <- sd(pull(filter(production, Site == "Boggy" & Year == "2017"), "lb_acre"))
stats$sd[2] <- sd(pull(filter(production, Site == "Boggy" & Year == "2018"), "lb_acre"))
stats$sd[3] <- sd(pull(filter(production, Site == "Boggy" & Year == "2019"), "lb_acre"))
stats$sd[4] <- sd(pull(filter(production, Site == "Wildcat" & Year == "2017"), "lb_acre"))
stats$sd[5] <- sd(pull(filter(production, Site == "Wildcat" & Year == "2018"), "lb_acre"))
stats$sd[6] <- sd(pull(filter(production, Site == "Wildcat" & Year == "2019"), "lb_acre"))
print(stats)
```

```{r}
## calculate standard deviation SD for each year and site (in g/m2)
stats$se[1] <- se(pull(filter(production, Site == "Boggy" & Year == "2017"), "lb_acre"))
stats$se[2] <- se(pull(filter(production, Site == "Boggy" & Year == "2018"), "lb_acre"))
stats$se[3] <- se(pull(filter(production, Site == "Boggy" & Year == "2019"), "lb_acre"))
stats$se[4] <- se(pull(filter(production, Site == "Wildcat" & Year == "2017"), "lb_acre"))
stats$se[5] <- se(pull(filter(production, Site == "Wildcat" & Year == "2018"), "lb_acre"))
stats$se[6] <- se(pull(filter(production, Site == "Wildcat" & Year == "2019"), "lb_acre"))
print(stats)
```

```{r}
## calculate standard deviation SD for each year and site (in g/m2)
stats$se[1] <- se(pull(filter(production, Site == "Boggy" & Year == "2017"), "lb_acre"))
stats$se[2] <- se(pull(filter(production, Site == "Boggy" & Year == "2018"), "lb_acre"))
stats$se[3] <- se(pull(filter(production, Site == "Boggy" & Year == "2019"), "lb_acre"))
stats$se[4] <- se(pull(filter(production, Site == "Wildcat" & Year == "2017"), "lb_acre"))
stats$se[5] <- se(pull(filter(production, Site == "Wildcat" & Year == "2018"), "lb_acre"))
stats$se[6] <- se(pull(filter(production, Site == "Wildcat" & Year == "2019"), "lb_acre"))
print(stats)
```

```{r}
stats$L95 <- stats$avg_lbs_acre-2.571*stats$se
stats$U95 <- stats$avg_lbs_acre+2.571*stats$se
print(stats)
```
```{r}
# Color-blind friendly colors
colors <- viridis(2)

print(colors)

# Excel colors
c("#4472C4", "#ED7D31", "#FFC000")
```

```{r}
jpeg(filename = "figures/production/Production.jpeg",
    width=6.5,
    height=6.5,
    units="in",
    res=300)
plot.new()
# bottom, left, top, right
par(mar=c(5, 5, 5, 2))
barplot(as.numeric(stats$avg_lbs_acre),
        #col = c(rep(colors[1], 3), rep(colors[2], 3)),
        col = c(rep("#4472C4", 3), rep("#ED7D31", 3)),
        axes = FALSE,
        #names.arg=(c("Production", "Availability")),
        ylab = expression(paste("pounds ", "acre"^"-1", " ± SE")),
        cex.lab = 1,
        cex.main = 1,
        ylim = c(0, 6500))
title(main = "White Mountain Vegetation Production")
mtext("2017-2019", 3, adj = 0.5)

axis(2, at=c(seq(0,6500,1000)),labels=c(seq(0,6500,1000)), cex.axis= 0.75, las = 2)
axis(1, at=c(0.7, 1.9, 3.1, 4.3, 5.5, 6.7), labels = c("Boggy 2017", "Boggy 2018", "Boggy 2019", "Wildcat 2017", "Wildcat 2018", "Wildcat 2019"), cex.axis= 0.75, las = 2)

segments(0.7, stats$avg_lbs_acre[1] - stats$se[1], 0.7, stats$avg_lbs_acre[1] + stats$se[1], lwd = 1)
arrows(0.7, stats$avg_lbs_acre[1]-stats$se[1], 0.7, stats$avg_lbs_acre[1] + stats$se[1], lwd = 1, angle = 90, code = 3, length = 0.05)

segments(1.9, stats$avg_lbs_acre[2] - stats$se[2], 1.9, stats$avg_lbs_acre[2] + stats$se[2], lwd = 1)
arrows(1.9, stats$avg_lbs_acre[2] - stats$se[2], 1.9, stats$avg_lbs_acre[2] + stats$se[2], lwd = 1, angle = 90,code = 3, length = 0.05)

segments(3.1, stats$avg_lbs_acre[3] - stats$se[3], 3.1, stats$avg_lbs_acre[3] + stats$se[3], lwd = 1)
arrows(3.1, stats$avg_lbs_acre[3] - stats$se[3], 3.1, stats$avg_lbs_acre[3] + stats$se[3], lwd = 1, angle = 90,code = 3, length = 0.05)

segments(4.3, stats$avg_lbs_acre[4] - stats$se[4], 4.3, stats$avg_lbs_acre[4] + stats$se[4], lwd = 1)
arrows(4.3, stats$avg_lbs_acre[4] - stats$se[4], 4.3, stats$avg_lbs_acre[4] + stats$se[4], lwd = 1, angle = 90,code = 3, length = 0.05)

segments(5.5, stats$avg_lbs_acre[5] - stats$se[5], 5.5, stats$avg_lbs_acre[5] + stats$se[5], lwd = 1)
arrows(5.5, stats$avg_lbs_acre[5] - stats$se[5], 5.5, stats$avg_lbs_acre[5] + stats$se[5], lwd = 1, angle = 90,code = 3, length = 0.05)

segments(6.7, stats$avg_lbs_acre[6] - stats$se[6], 6.7, stats$avg_lbs_acre[6] + stats$se[6], lwd = 1)
arrows(6.7, stats$avg_lbs_acre[6] - stats$se[6], 6.7, stats$avg_lbs_acre[6] + stats$se[6], lwd = 1, angle = 90,code = 3, length = 0.05)

text(0.7, 5700, "4705", pos = 3, cex = 0.75)
text(1.9, 4200, "3483", pos = 3, cex = 0.75)
text(3.1, 3800, "3035", pos = 3, cex = 0.75)
text(4.3, 5500, "4766", pos = 3, cex = 0.75)
text(5.5, 3900, "3271", pos = 3, cex = 0.75)
text(6.7, 2700, "2310", pos = 3, cex = 0.75)

dev.off()
```